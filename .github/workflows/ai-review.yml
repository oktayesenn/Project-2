name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install openai @octokit/action

      - name: Run AI Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          import { Octokit } from '@octokit/action';
          import OpenAI from 'openai';
          import fs from 'fs';

          const octokit = new Octokit();
          const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

          async function run() {
            const prRef = process.env.GITHUB_REF;
            const prNumber = Number(prRef.split('/')[2]);
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            const { data: files } = await octokit.rest.pulls.listFiles({
              owner, repo, pull_number: prNumber, per_page: 20
            });

            const code = files
              .filter(f => ['.html', '.css', '.js'].some(ext => f.filename.endsWith(ext)))
              .slice(0, 10)
              .map(f => `File: ${f.filename}\n\n${f.patch || ''}`)
              .join('\n\n');

            const prompt = \`
You are a computer science teacher reviewing a student's assignment.
Provide clear, encouraging feedback on their HTML/CSS/JS code:
- Give a score (0â€“100)
- Mention structure, readability, and correctness
- Suggest 3 improvements
Keep it short and kind.

Student code changes:
\${code}
            \`;

            const result = await openai.chat.completions.create({
              model: 'gpt-4o-mini',
              messages: [{ role: 'user', content: prompt }]
            });

            const review = result.choices[0].message.content;

            await octokit.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: '### ðŸ¤– AI Code Review\n' + review + '\n\n> This feedback was generated automatically for learning purposes.'
            });
          }

          run().catch(err => { console.error(err); });
          "
